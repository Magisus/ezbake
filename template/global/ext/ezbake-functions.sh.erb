#! /bin/bash
#

#
# Wait START_TIMEOUT seconds for the application to bind to any TCP port
#
wait_for_app()
{
    local pid=${1}
    local timeout=${2}

    while : ;do

        # verify the process is still running; if not, return failure
        ps -p $pid 2>&1 > /dev/null
        if [ ! "$?" -eq 0 ] ;then
            return 1
        fi

        # if there are any TCP ports associated with the process, return success
        netstat -tulpn | grep $pid 2>&1 >/dev/null
        if [ "$?" -eq 0 ] ;then
            return 0
        fi

        # if we reach the timeout, return failure
        if [ "$timeout" -eq 0 ] ;then
            return 1
        fi

        sleep 1
        timeout=$(($timeout-1))

    done
}

if [ "$0" = "$BASH_SOURCE" ] ;then
    COMMAND=${1:?}
    eval export $(systemctl show -p MainPID <%= EZBake::Config[:project] %>.service)
    case $COMMAND in
        wait_for_app)
            wait_for_app ${MainPID} ${START_TIMEOUT}
        ;;
        *)
        ;;
    esac
fi
